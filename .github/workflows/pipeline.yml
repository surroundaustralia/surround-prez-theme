name: Deploy Changes
on:
  push:
    branches:
      - main
  workflow_dispatch:
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2
      - name: Install python dependencies
        run: |
          python -m pip install -U pip
          pip install poetry
          poetry install
      - name: Token replacement
        run: python pipeline_script.py
        env:
          SPARQL_ENDPOINT: ${{ secrets.SPARQL_ENDPOINT }}
          SPARQL_USERNAME: ${{ secrets.SPARQL_USERNAME }}
          SPARQL_PASSWORD: ${{ secrets.SPARQL_PASSWORD }}
      - name: Get app name
        run: "echo ::set-output name=appName::$(sed -n -e 's/^.*appName: \\(.*\\)/\\1/p' config.yaml)"
        id: get_app_name
      - name: Temporarily remove theme variable
        run: sed -e 's/THEME_VOLUME:/# THEME_VOLUME:/g' deploy/new_kube-manifest.yaml > deploy/new_kube-manifest-replace.yaml
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-2
      - name: Deploy temp manifest
        uses: kodermax/kubectl-aws-eks@master
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG }}
        with:
          args: apply -f deploy/new_kube-manifest-replace.yaml --validate=false
      - name: Restart deployment
        uses: kodermax/kubectl-aws-eks@master
        with:
          args: rollout restart deployment ${{ steps.get_app_name.outputs.appName }}-prez-deployment
      - name: Get newest pod name
        uses: kodermax/kubectl-aws-eks@master
        with:
          args: get pod --sort-by=.metadata.creationTimestamp -l app=${{ steps.get_app_name.outputs.appName }} -o jsonpath="{.items[-1:].metadata.name}" > podName.txt
      - name: Save pod name to variable
        run: echo ::set-output name=podName::$(cat podName.txt)
        id: save_pod_name
      - name: Exec into pod
        uses: kodermax/kubectl-aws-eks@master
        with:
          args: exec -it ${{ steps.save_pod_name.outputs.podName }} -- /bin/bash
      - name: Clear mounted folder
        run: |
          rm -rf /app/prez/theme/*
          exit
      - name: Copy theme files
        uses: kodermax/kubectl-aws-eks@master
        with:
          args: cp theme/* ${{ steps.save_pod_name.outputs.podName }}:/app/prez/theme/
      - name: Deploy real manifest
        uses: kodermax/kubectl-aws-eks@master
        with:
          args: apply -f deploy/new_kube-manifest.yaml --validate=false
      - name: Restart deployment
        uses: kodermax/kubectl-aws-eks@master
        with:
          args: rollout restart deployment ${{ steps.get_app_name.outputs.appName }}-prez-deployment
